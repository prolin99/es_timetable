<link rel="stylesheet" type="text/css" media="all" href="<{$xoops_url}>/modules/tadtools/bootstrap/css/bootstrap.css" />
<link rel="stylesheet" type="text/css" media="all" href="<{$xoops_url}>/modules/tadtools/bootstrap/css/bootstrap-responsive.css" />
<link rel="stylesheet" type="text/css" media="all" href="<{$xoops_url}>/modules/tadtools/css/xoops_adm.css" />
<link rel="stylesheet" href="<{$xoops_url}>/modules/tadtools/jquery/themes/base/jquery-ui.css">
<script src="<{$xoops_url}>/modules/tadtools/jquery/ui/jquery-ui.js"></script>
<style>
.groupbox {
 
    border: 1px dotted gray;
    background-color: #EEE;
    
 
}
.teacher_set {
 
    border: 1px dotted gray;
 
}
</style>
 
 <h3><{$data.n_y}> 學年度<{$data.n_s}> 學期</h3>
  
      <div class="row-fluid" > <!-- box1 -->
      
      
   
      <div class="span2" > <!-- left  -->
        
        <div id="kmo_div">
        <!--  科目 -->
      	<{foreach  key=s_key item=subject    from= $data.subject_name }>
      		   <span class="span5 subj" data_ref="subj_<{$s_key}>_<{$subject}>"  ><label  id="subj_<{$s_key}>" title='<{$subject}>' name_title='<{$subject}>' class="label label-success">
      		   <{$subject}></label><i id="i_<{$s_key}>" ></i></span>
      	<{/foreach }>
      	</div>
      	
      	<div>
      	<!--  教師 -->
      	<{foreach  key=t_key item=teacher    from= $data.teacher_list }>
      		   <span class="span4 tea" data_ref="tea_<{$t_key}>_<{$teacher}>"  ><label  id="tea_<{$t_key}>" title='<{$teacher}>' name_title='<{$teacher}>' class="label label-info">
      		   <{$teacher}></label><i id="i_<{$t_key}>" ></i></span>
      	<{/foreach }>      
      	</div>
      	
      </div> <!--left end-->

      <div class="span10" id="table_div">
      	<div class="row-fluid" >
      	<div class='span3'>
      	班級：<{html_options name=class_id id=class_id  options=$data.class_list  selected=$data.select_class_id  onchange="class_chang();"  class="span8" }> 
      	</div>
      	<div class='span4'>
      	<span class="span3">任教者</span><div class="span8 teacher_set" id="teacher_point" data_ref="" >教師拖入</div>
      	</div>
      	<div class='span4'>
      	<span class="span3">教室</span><input name="room" id='room' placeholder="教室" class="span6" type="text">
      	</div>
      	</div>

      <table class="table table-bordered">
      <tr>
      <td class="span1">節</td>
      <{section name=di  start=1  loop=$DEF_SET.days  step=1  }>
      <td ><{$smarty.section.di.index}></td>
      <{ /section }>
      </tr>      
      <{section name=si  start=1  loop=$DEF_SET.sects    step=1  }>
      <tr>
      <td class="span1"><{$smarty.section.si.index}></td>
      <{section name=di  start=1  loop=$DEF_SET.days    step=1  }>
      <td class="span2">
      	<i   id="lock_<{$smarty.section.di.index}>_<{$smarty.section.si.index}>"  title="有課"></i>
      	<div class="groupbox span12" data_ref="sect_<{$smarty.section.di.index}>_<{$smarty.section.si.index}>" id="sect_<{$smarty.section.di.index}>_<{$smarty.section.si.index}>" ><{$group}><br /><br /></div>

      </td>
      <{ /section }>
      </tr>
      <{ /section }>
      </table>

      
      </div>      <!-- table_div end-->

      
      </div><!-- box1 end-->
      
      <div class="row-fluid">
      	<p>
            <span class="label label-info">說明</span><br/>
           把人員拖曳到各群組名稱上，就會加入該群組。垃圾桶圖示表示移出該群組。<br/>
           只出現校內教職員後的群組名稱。重複拖曳到同一群組，會出現多次姓名，但不影響資料的正確。 
        </p>  
      </div>
      
<script>

var now_teacher_array='' ;
var now_teacher_ref='' ;

//可拖拉
$(function () {
        $(".tea").draggable({
                revert: "valid",
                drag: function (event, ui) {
                        
                }
        });
        $(".subj").draggable({
                revert: "valid",
                drag: function (event, ui) {
                        
                }
        });        

        $(".groupbox").droppable({
                drop: function (event, ui) {
                	var sect = $(this).attr("data_ref")  ;
                    var user_data = ui.draggable.attr('data_ref') ;
                    sect_show(sect , user_data , now_teacher_array) ;
 

                } 
 
        });
        
        $(".teacher_set").droppable({
                drop: function (event, ui) {

                    var user_data = ui.draggable.attr('data_ref');
                    var splits = user_data.split('_') ;
                    if (splits[0]=='tea'){
 						now_teacher_array =splits ;
 						teacher_box(now_teacher_array ) ;
 						now_teacher_ref=user_data ;
 					}	

                },
                out: function (event, ui) {
                      now_teacher='' ;
                      teacher_box ('教師拖入') ;
                }
        });        
});

function teacher_box(tea) {
	$('#teacher_point').html( '<span class="label label-important" data_ref="" >'+tea[2] + '</span>') ;
	
	//秀出是否已有課的記號
	
}


function sect_show(sect , subject_data , now_teacher) {
	if(now_teacher=='') 
	 	alert('未指定教師')  ;
	else { 
	
		var splits = subject_data.split('_') ;
		if (splits[0]=='subj') {
			var room = $('#room').val() ;
			
			$('#' + sect).html('<span class="label label-success" >'+splits[2]+'<i class="icon-remove" data_ref="'+sect+'" title="刪除"></i></span><br/><span class="label label-info">'+ now_teacher[2]+'</span><br/><span class="label">'+room+'</span> ') ;
			ajax_time_table('add' , sect , subject_data , now_teacher_ref , room ) ;
		}
	}
	
}

 

    //消除 ----------------------------------------------------------------------------------
  $(document).on("click", ".icon-remove", function(){

    var mark_id = $(this).attr("data_ref")  ;
   // alert (mark_id) ;
    $('#' + mark_id).html('<br/><br/>') ;
 //   var splits = mark_id.split('_') ;
//    $(this).parent().parent().remove() ;
 	ajax_time_table('del' , mark_id , '' , '') ;
  });
  
 var ajax_time_table=function( do_mode ,sect_num , subject_data , user ,room_place ){
 
      	  //記錄
            var URLs="ajax_set_timetable.php" ;
            var class = $("class_id").val() ;
    
            $.ajax({
                url: URLs,
                type:"GET",
                dataType:'text',
				data:{year:<{$data.n_y}> , semester:<{$data.n_s}> ,class_id:class , sect:sect_num, subject:subject_data , teacher:user, room:room_place , do:do_mode },
                success: function(msg){
                   // alert(msg);
                },

                 error:function(xhr, ajaxOptions, thrownError){
                    alert('error:' + xhr.status);
                    alert(thrownError);
                 }
           })
 }  

</script> 